---
# script that updates the centraldashboard image tag, regenerates the unit tests, runs "go test -v"
# should be replaced by the python script that does the same
apiVersion: v1
data:
  rebuild-manifests.sh: |-
    #!/usr/bin/env bash
    pushd ../common/centraldashboard/base
    echo updating image in centraldashboard/kustomization.yaml
    kustomize edit set image gcr.io/kubeflow-images-public/centraldashboard=gcr.io/kubeflow-images-public/centraldashboard@$(cat /kubeflow/centraldashboard-digest)
    popd
    make generate
    make test
kind: ConfigMap
metadata:
  name: update-manifests-commands
  namespace: kubeflow-test-infra
---
# Pipeline runs build-push and update-manifests Tasks
# PipelineResources of type git are added for kubeflow, manifests so these repos are available under /workspace
# PipelineResources of type image is added for generation of the Docker image by kaniko in the build-push Task
# Each Task (build-push, update-manifests) takes parameters supplied by Pipeline. 
# All components can use this template if these parameters are supplied by py_func in prow_config
apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  labels:
    scope: kubeflow-test-infra
  name: ci-pipeline
  namespace: kubeflow-test-infra
spec:
  params: []
  resources:
  - name: kubeflow
    type: git
  - name: centraldashboard
    type: image
  - name: manifests
    type: git
  tasks:
  - name: build-push
    params:
    - name: pathToDockerfile
      value: components/centraldashboard/Dockerfile
    - name: pathToContext
      value: components/centraldashboard
    - name: dockerTarget
      value: serve
    resources:
      inputs:
      - name: kubeflow
        resource: kubeflow
      outputs:
      - name: centraldashboard
        resource: centraldashboard
    taskRef:
      name: build-push
  - name: update-manifests
    params:
    - name: pathToManifestsTestsDir
      value: tests
    - name: container_image
      value: gcr.io/kubeflow-ci/test-worker:latest
    resources:
      inputs:
      - name: manifests
        resource: manifests
      - from:
        - build-push
        name: centraldashboard
        resource: centraldashboard
      outputs:
      - name: manifests
        resource: manifests
    runAfter:
    - build-push
    taskRef:
      name: update-manifests
---
# Builds a docker container. The image tag is available at /kubeflow/centraldashboard-digest
# /kubeflow is a PersistentVolume shared by Tasks {build-push, update-manifests} in the Pipeline
# /kubeflow/centraldashboard-digest is written by build-push and read by update-manifests
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: build-push
  namespace: kubeflow-test-infra
spec:
  inputs:
    params:
    - description: The path to the dockerfile to build
      name: pathToDockerfile
      type: string
    - description: The build context used by Kaniko
      name: pathToContext
      type: string
    - description: docker target arg
      name: dockerTarget
      type: string
    resources:
    - name: kubeflow
      type: git
  outputs:
    resources:
    - name: centraldashboard
      outputImageDir: /kubeflow
      type: image
  steps:
  - args:
    - --dockerfile=/workspace/${inputs.resources.kubeflow.name}/${inputs.params.pathToDockerfile}
    - --destination=${outputs.resources.centraldashboard.url}
    - --context=/workspace/${inputs.resources.kubeflow.name}/${inputs.params.pathToContext}
    - --target=${inputs.params.dockerTarget}
    - --digest-file=/kubeflow/centraldashboard-digest
    command:
    - /kaniko/executor
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    image: gcr.io/kaniko-project/executor:v0.11.0
    name: build-push
    volumeMounts:
    - mountPath: /secret
      name: kaniko-secret
    - mountPath: /kubeflow
      name: kubeflow
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - name: kubeflow
    persistentVolumeClaim:
      claimName: ci-pipeline-run-persistent-volume-claim
---
# Does the following:
# updates the image tag in the local github repo which is a PipelineResource of type git
# calls make generate; make test
# TBD
# rebase from master
# create PR with the imagetag change in common/centraldashboard/base/kustomization.yaml and the updated unit test.
apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: update-manifests
  namespace: kubeflow-test-infra
spec:
  inputs:
    params:
    - default: /workspace/manifests/tests
      description: Where manifests tests are generated and run
      name: pathToManifestsTestsDir
      type: string
    - description: pod container image
      name: container_image
      type: string
    resources:
    - name: manifests
      type: git
    - name: centraldashboard
      type: image
  outputs:
    resources:
    - name: manifests
      type: git
  steps:
  - command:
    - /bin/bash
    - /update-manifests-commands/rebuild-manifests.sh
    env:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: /secret/kaniko-secret.json
    image: ${inputs.params.container_image}
    name: update-manifests
    volumeMounts:
    - mountPath: /secret
      name: kaniko-secret
    - mountPath: /kubeflow
      name: kubeflow
    - mountPath: /update-manifests-commands
      name: update-manifests-commands
    workingDir: /workspace/${inputs.resources.manifests.name}/${inputs.params.pathToManifestsTestsDir}
  volumes:
  - name: kaniko-secret
    secret:
      secretName: kaniko-secret
  - configMap:
      name: update-manifests-commands
    name: update-manifests-commands
  - name: kubeflow
    persistentVolumeClaim:
      claimName: ci-pipeline-run-persistent-volume-claim
---
# Supporting resource for PipelineRun which requires a ServiceAccount with appropriate RBAC
apiVersion: v1
imagePullSecrets:
- name: docker-secret
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: ci-pipeline-run-service-account
  namespace: kubeflow-test-infra
---
# Supporting resource for PipelineRun which requires a ClusterRoleBinding with the ServiceAccount noted above.
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: ci-pipeline-run-cluster-role-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: ci-pipeline-run-service-account
  namespace: kubeflow-test-infra
---
# Supporting resource needed to run kaniko
data:
  kaniko-secret.json: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAiY29uc3RhbnQtY3ViaXN0LTE3MzEyMyIsCiAgInByaXZhdGVfa2V5X2lkIjogImQxMjkzODQ1NWI2NGEyZDlhZWE1MDVjNjZkNzIyMjJmNmUyNDg0MzYiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2UUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktjd2dnU2pBZ0VBQW9JQkFRQ2dJRHptZmFqMkdKSnVcbjlvOUxsa3dDYXIvVXYyalN3MEJTRXpNeWozQlNCc3BSdXVhOG1qU3MyZTdNRjVnYmMxVGdoL21HSkNqMitZS3JcbkZDOHdyMEt5bWx6NDdRWE5aeUMxb2I2TitxUnJncEJyeXNZWE1iSkFnQUFQck1rS2lhY2VjRzBHN3JkVGhjQVNcblh2Y2hBZG9RdTFTTWhNQys4aEtHMytpM1ZETXE2K3o4ZStwL1AzeEhhdUl3UTBYcWp4RGpONE5VRlMrbTF3WG9cbmpQM2xkbE15cWJUZHFvdFNHanIrTUxJZ1U3OEowdlp1NDF5WDl1ZjY2QWJyOE91N2E4bFdpVnpJUzZubHVqSTJcbm00T3NWYXlZaUN6dHhOam5iazVCVUhaYXZpekNaLzE1YzRlWFRuYXlsQXI0S2IrS3ZHSk5XbXVjSUdjQlNkZnlcbjhGZE1aNEdSQWdNQkFBRUNnZ0VBQWhXaFdpQ1Y4d3d4dmMvMHh1UmdQVzgzQlM4OGdveXVjcmw1OWpIOGgvd0lcbkpSN3VHWWJ3bE9nUXg3Ukg3UldPVWx0YXkzYVl2b1h0ZitPOW9JYXJqTnVRclBubUlUQW1QMDhQMzRpV3RnOWdcbjZRV0UvdkROSU10VFlhMm9NdStyVHRMNzhzTG5zQ2ExMWxkaTE0QUNPS3R3Ymk0UWIwaTJ3Q0VJK1Y1a0ZsVElcbmlkZkFiWGdiakt6dDR0dFg5YmR3OVBpUEcrTkRxQkVpQ0FiaXNMYmxyWlVOWUl1WVVsVWpoTmNKS29hRWNXQkdcbkMzcS9BMk1oTElTZ2FVQlYyZnludXEyaVdVZFZQTGwxNTRNNWtMREFSNk8rS0J6UWVZVnUraGxzdVcrSE1qcGFcbjI5U05FSWhuWmYySERPTi82bUw3R1VEcVlOblhISDVCK1AvT3NnSVQ5UUtCZ1FEV3R4SWNXSks3NFdadmhYeGNcbktOR1pLdHlxQWxielhSVFI3M1NGTVpSQjZNUjdEOFloenIwN3dmRXI5UEk5ekl3QjB3V3BzR2VGRVFQUFpTYXlcbnlKaDQxcTkvYlZ2bUtiM2svRndrMmVFSy9JRFBNRzdqTHdqbVBBbG5UYVpVRUZncHVKYUw5VEVvYlBSWXZtbGVcbmpyeXNmNVRpWXBIY3RkVlhkL3IwZzRqbDNRS0JnUUMrNmg4a28yNVkrS3BPRitxaGU3UnA1Z1VZdFhwQjh6RnpcbjB1UnZacE5DQXFMUmw3Vjk5RW9YcnBZWFF5TE5CY3BSUkpDaEpVenZDMkRtWVhhRXhLUzlWbmZYSzRncG5uVzZcbnAzSitPQ0NtOUJOdUMrYStxYXp0WDluK1JrRXpaem0waFdjTFRTejVpUlhrOWkxTkRKZnY4aXBKd1ptMnhPNDBcbkNXdU5pZ2R4UlFLQmdEbllhRkNxckIxaHhDOFhUMEdrM1pMZU1VUzhES0RUMnVBVUd0Z25XMEhHYStpYmYwMXNcblhSN1VTUjBHaUp5TmxzcUhCMmVIMXR2S2tiUTJGQTdtYSsxaUtUV3pTS2JoWi85ZzNaSXdBS2p0RGViRHJad1dcbjk5YlBKZGxtMmdDYnhxUzJ6aGcybmwrOXVyYU4xZVZibndqNTlpcG5VOVNhU0RlZ1kwT3NqQjBoQW9HQkFKUzRcbnN5d0tlRktzMjVaY1FUWXN0TDF1SjNnNUh4VXpDc29NZGxGbDJiOHBhSWJYcE5XS3NSRkR1cjVDV1dEWGF1VG1cbkFialc0dGl3eDNxUVlCQkxVMzMvVnZueWVtN1pkeUxCZ0lwYzFPclo1aXpxN29TR2p5U1hiNjBLTTQ2RWtrcFRcblJaTmpPbTdsWUgzdFhCclNmYVc0dzBLVG8xZmlqeUZRV1UxNFFoWDFBb0dBSnJrcHg5TjE5UExnQ3MrWDhKa1ZcblRRZXppeHpUd0VLekdRQVU1SnJVai9Cd1g5RDBMa2tkSVdXWXBTMzZqdnpqQUM2Nk93SHBOQlF2dXRRRC9CU3FcbjZUd0ovbVhQN1p0U1hsUFd3MGExVkhNNG5oTmcrbDRXR3BHNCtmdTduZUM5bHlJZkZ2am1jZHM1d0RNNXRDOVFcbjcwOUlYSDEzamdXbzlNYzQyTExkdUxFPVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImRvY2tlckBjb25zdGFudC1jdWJpc3QtMTczMTIzLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExMzA4NDc2Nzg5NTE3MzQ1MTIwOCIsCiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRoIiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwKICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvZG9ja2VyJTQwY29uc3RhbnQtY3ViaXN0LTE3MzEyMy5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
kind: Secret
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: kaniko-secret
  namespace: kubeflow-test-infra
type: Opaque
---
# Supporting resource that allows deletion of all resources by using the instance label
# including cluster resources
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: ci-centraldashboard-pipeline-run-52fdfc07
  namespace: kubeflow-test-infra
spec:
  addOwnerRef: true
  componentKinds:
  - group: app.k8s.io
    kind: Application
  descriptor:
    description: a pipeline run that composes resources and tasks
    keywords:
    - kubeflow
    links:
    - description: About
      url: https://kubeflow.org
    maintainers:
    - email: kam.d.kasravi@intel.com
      name: Kam Kasravi
    owners:
    - email: kam.d.kasravi@intel.com
      name: Kam Kasravi
    type: ci-pipeline-run
    version: v1beta1
---
# Supporting resource PipelineResource of type image
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: centraldashboard
  namespace: kubeflow-test-infra
spec:
  params:
  - name: url
    value: gcr.io/kubeflow-images-public/centraldashboard
  type: image
---
# Supporting resource PipelineResource of type git for kubeflow
# TBD
# Needs to change its url to git@github.com and the ServiceAccount needs to have the GITHUB_TOKEN secret under secrets:
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: kubeflow
  namespace: kubeflow-test-infra
spec:
  params:
  - name: revision
    value: pull/4091/head
  - name: url
    value: https://github.com/kubeflow/kubeflow
  type: git
---
# Supporting resource PipelineResource of type git for manifests
# TBD
# Needs to change its url to git@github.com and the ServiceAccount needs to have the GITHUB_TOKEN secret under secrets:
apiVersion: tekton.dev/v1alpha1
kind: PipelineResource
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: manifests
  namespace: kubeflow-test-infra
spec:
  params:
  - name: revision
    value: master
  - name: url
    value: https://github.com/kubeflow/manifests
  type: git
---
# Runs the Pipeline. PipelineResources are defined here. Tasks are defined in Pipeline
apiVersion: tekton.dev/v1alpha1
kind: PipelineRun
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
    scope: kubeflow-test-infra
  name: ci-centraldashboard-pipeline-run-52fdfc07
  namespace: kubeflow-test-infra
spec:
  pipelineRef:
    name: ci-pipeline
  resources:
  - name: kubeflow
    resourceRef:
      name: kubeflow
  - name: manifests
    resourceRef:
      name: manifests
  - name: centraldashboard
    resourceRef:
      name: centraldashboard
  serviceAccount: ci-pipeline-run-service-account
---
# Shared across Tasks as persistent storage. 
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    app.kubernetes.io/component: kubeflow
    app.kubernetes.io/instance: ci-centraldashboard-pipeline-run-52fdfc07
    app.kubernetes.io/managed-by: kfctl
    app.kubernetes.io/name: ci-pipeline-run
    app.kubernetes.io/part-of: kubeflow
    app.kubernetes.io/version: v0.6
  name: ci-pipeline-run-persistent-volume-claim
  namespace: kubeflow-test-infra
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
