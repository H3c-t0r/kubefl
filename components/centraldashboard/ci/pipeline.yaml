apiVersion: tekton.dev/v1alpha1
kind: Pipeline
metadata:
  name: ci-pipeline
spec:
  params: 
  - name: container_image
  - name: docker_target
  - name: image_name
  - name: path_to_context
  - name: path_to_docker_file
  - name: path_to_manifests_dir
  - name: pull_request_id
  - name: pull_request_repo
  resources:
  - name: $(pull_request_repo)
    type: git
  - name: $(image_name)
    type: image
  - name: manifests
    type: git
  - name: $(pull_request_repo)-$(pull_request_id)
    type: pullRequest
  tasks:
  - name: build-push
    params:
    - name: dockerTarget
      value: $(params.docker_target)
    - name: pathToContext
      value: $(params.path_to_context)
    - name: pathToDockerfile
      value: $(params.path_to_docker_file)
    resources:
      inputs:
      - name: $(pull_request_repo)
        resource: $(pull_request_repo)
      outputs:
      - name: $(image_name)
        resource: $(image_name)
    taskRef:
      name: build-push
      kind: namespaced
  - name: update-manifests
    runAfter:
    - build-push
    params:
    - name: containerImage
      value: "$(params.container_image)"
    - name: imageName
      value: $(params.image_name)
    - name: pathToManifestsDir
      value: "$(params.path_to_manifests_dir)"
    - name: pullRequestRepo
      value: "$(params.pull_request_repo)"
    - name: pullRequestId
      value: "$(params.pull_request_id)"
    resources:
      inputs:
      - name: $(pull_request_repo)
        resource: $(pull_request_repo)
      - name: manifests
        resource: manifests
      - name: $(pull_request_repo)-$(pull_request_id)
        resource: $(pull_request_repo)-$(pull_request_id)
      - name: $(image_name)
        resource: $(image_name)
        from:
        - build-push
    taskRef:
      name: update-manifests
      kind: namespaced
